<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>SSN Campus 3D Navigator - Final</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }

        /* Modern Control Panel */
        .nav-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.98);
            padding: 20px;
            border-radius: 16px;
            z-index: 10;
            width: 320px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
        }

        h3 {
            color: #2c3e50;
            margin-top: 0;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        label {
            color: #7f8c8d;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 5px;
            display: block;
        }

        select,
        button {
            width: 100%;
            padding: 12px;
            margin-top: 8px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            font-size: 14px;
            outline: none;
            transition: 0.2s;
        }

        select:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        button#route-btn {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            font-weight: 600;
            border: none;
            cursor: pointer;
            margin-top: 15px;
        }

        button#route-btn:active {
            transform: scale(0.98);
        }

        /* Satellite Toggle */
        .map-style-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 10;
            cursor: pointer;
            font-weight: 600;
            color: #333;
            border: 1px solid #eee;
        }

        .map-style-toggle:hover {
            background: #f8f9fa;
        }

        .stats {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            color: #555;
            font-size: 0.9rem;
        }

        .stat-box strong {
            display: block;
            color: #333;
            font-size: 1.1rem;
        }

        #loading {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 30px;
            border-radius: 30px;
            z-index: 20;
            font-weight: bold;
        }
    </style>
</head>

<body>

    <div class="nav-panel">
        <h3>üìç SSN Navigator</h3>

        <label>Where to?</label>
        <select id="dest-nodes">
            <!-- populated by JS -->
        </select>

        <button id="route-btn" onclick="calculateCampusRoute()">Navigate Now ‚ûî</button>

        <div class="stats">
            <div class="stat-box">Dist: <strong id="dist-txt">0 m</strong></div>
            <div class="stat-box">Time: <strong id="eta-txt">0 min</strong></div>
        </div>
    </div>

    <button class="map-style-toggle" onclick="toggleMapStyle()">üõ∞Ô∏è Satellite View</button>
    <div id="loading">Calculating...</div>

    <div id="map"></div>

    <script>
        mapboxgl.accessToken = 'map_key paste here';

        // FINAL DATA - Verified by User
        const campusData = {
            "Hostels (Gents)": [
                {
                    "name": "Gents Hostel 1",
                    "coords": [
                        80.19930856138353,
                        12.751417788270132
                    ]
                },
                {
                    "name": "Gents Hostel 2",
                    "coords": [
                        80.19849811503701,
                        12.751565529503651
                    ]
                },
                {
                    "name": "Gents Hostel 3",
                    "coords": [
                        80.19958412738316,
                        12.75070473039412
                    ]
                },
                {
                    "name": "Gents Hostel 4",
                    "coords": [
                        80.19893369969651,
                        12.75057449209018
                    ]
                },
                {
                    "name": "Gents Hostel 5",
                    "coords": [
                        80.19920040493804,
                        12.750068491242246
                    ]
                },
                {
                    "name": "Gents Hostel 6",
                    "coords": [
                        80.2002368483711,
                        12.750438753967856
                    ]
                },
                {
                    "name": "Gents Hostel 7",
                    "coords": [
                        80.1993709393007,
                        12.749595240261996
                    ]
                },
                {
                    "name": "Gents Hostel 8",
                    "coords": [
                        80.19915654800656,
                        12.749058240350863
                    ]
                },
                {
                    "name": "Gents Hostel 9",
                    "coords": [
                        80.19894895238895,
                        12.749035129123968
                    ]
                },
                {
                    "name": "International Hostel (Nilavan)",
                    "coords": [
                        80.19976461047054,
                        12.75115587644379
                    ]
                }
            ],
            "Facilities & Spots": [
                {
                    "name": "Cricket Ground",
                    "coords": [
                        80.19111695300631,
                        12.752543351342396
                    ]
                },
                {
                    "name": "Laundry",
                    "coords": [
                        80.1993255212904,
                        12.751024906309851
                    ]
                },
                {
                    "name": "SNU Building",
                    "coords": [
                        80.19245232819594,
                        12.752139172154216
                    ]
                },
                {
                    "name": "Snow Cube",
                    "coords": [
                        80.19513777391933,
                        12.751398182426556
                    ]
                },
                {
                    "name": "Laugh and Joy",
                    "coords": [
                        80.19699557944301,
                        12.749268803147842
                    ]
                },
                {
                    "name": "PR",
                    "coords": [
                        80.19291742111619,
                        12.750769056981198
                    ]
                },
                {
                    "name": "Aswins",
                    "coords": [
                        80.19798198888623,
                        12.753204075447925
                    ]
                },
                {
                    "name": "Rishab",
                    "coords": [
                        80.19514432456987,
                        12.75129843323191
                    ]
                }
            ],
            "Departments": [
                {
                    "name": "CSE Block",
                    "coords": [
                        80.19726,
                        12.75143
                    ]
                },
                {
                    "name": "IT & CDC Block",
                    "coords": [
                        80.19682,
                        12.75143
                    ]
                },
                {
                    "name": "ECE & EEE Block",
                    "coords": [
                        80.19618,
                        12.75072
                    ]
                },
                {
                    "name": "Mechanical Block",
                    "coords": [
                        80.19433,
                        12.75178
                    ]
                },
                {
                    "name": "BME & Chemical Block",
                    "coords": [
                        80.19761,
                        12.74929
                    ]
                },
                {
                    "name": "Civil Engineering",
                    "coords": [
                        80.19622,
                        12.74929
                    ]
                },
                {
                    "name": "School of Management",
                    "coords": [
                        80.19904,
                        12.75295
                    ]
                },
                {
                    "name": "English & Maths Block",
                    "coords": [
                        80.19705,
                        12.75199
                    ]
                },
                {
                    "name": "Admin Block",
                    "coords": [
                        80.19539,
                        12.75164
                    ]
                }
            ],
            "Landmarks": [
                {
                    "name": "SSN Main Gate",
                    "coords": [
                        80.20344,
                        12.75172
                    ]
                },
                {
                    "name": "Central Library",
                    "coords": [
                        80.19637,
                        12.75128
                    ]
                },
                {
                    "name": "Clock Tower",
                    "coords": [
                        80.19641,
                        12.75273
                    ]
                },
                {
                    "name": "Sports Complex",
                    "coords": [
                        80.19401,
                        12.75286
                    ]
                }
            ]
        };

        // 2. Populate Dropdown
        const select = document.getElementById('dest-nodes');
        for (const [category, places] of Object.entries(campusData)) {
            const group = document.createElement('optgroup');
            group.label = category;
            places.forEach(place => {
                const option = document.createElement('option');
                option.value = place.coords.join(',');
                option.textContent = place.name;
                group.appendChild(option);
            });
            select.appendChild(group);
        }

        // 3. Map Initialization
        let currentStyle = 'mapbox://styles/mapbox/standard';
        const map = new mapboxgl.Map({
            container: 'map',
            style: currentStyle,
            center: [80.1965, 12.7515],
            zoom: 17,
            pitch: 45, // Reverted to previous tilt
            bearing: -10
        });

        let activeDestMarker = null;

        map.on('load', () => {
            // Hide default points
            if (map.getLayer('poi-label')) map.setLayoutProperty('poi-label', 'visibility', 'none');

            map.addSource('mapbox-dem', { 'type': 'raster-dem', 'url': 'mapbox://mapbox.mapbox-terrain-dem-v1' });
            map.setTerrain({ 'source': 'mapbox-dem', 'exaggeration': 1.5 });

            addCustomCampusLayer();
        });

        function addCustomCampusLayer() {
            const features = [];
            for (const cat in campusData) {
                campusData[cat].forEach(place => {
                    features.push({
                        type: 'Feature',
                        geometry: { type: 'Point', coordinates: place.coords },
                        properties: { title: place.name }
                    });
                });
            }

            if (map.getSource('ssn-places')) {
                map.removeLayer('ssn-custom-labels');
                map.removeLayer('ssn-custom-dots');
                map.removeSource('ssn-places');
            }

            map.addSource('ssn-places', {
                type: 'geojson',
                data: { type: 'FeatureCollection', features: features }
            });

            // 4a. Text Labels (White Text with Blue Halo)
            map.addLayer({
                'id': 'ssn-custom-labels',
                'type': 'symbol',
                'source': 'ssn-places',
                'layout': {
                    'text-field': ['get', 'title'],
                    'text-font': ['Open Sans Semibold', 'Arial Unicode MS Bold'],
                    'text-offset': [0, 1.0],
                    'text-anchor': 'top',
                    'text-size': 12,
                    'text-max-width': 10
                },
                'paint': {
                    'text-color': '#ffffff',
                    'text-halo-color': '#003366',
                    'text-halo-width': 2
                }
            });

            // 4b. Unified Dots (SSN Blue)
            map.addLayer({
                'id': 'ssn-custom-dots',
                'type': 'circle',
                'source': 'ssn-places',
                'paint': {
                    'circle-radius': 6,
                    'circle-color': '#003366',
                    'circle-stroke-width': 2,
                    'circle-stroke-color': '#ffffff'
                }
            });
        }

        // 5. User Location
        const userMarker = new mapboxgl.Marker({ color: '#2ecc71', scale: 1.0 })
            .setLngLat([80.20344, 12.75172]) // Default: Main Gate
            .addTo(map);

        if (navigator.geolocation) {
            navigator.geolocation.watchPosition((pos) => {
                userMarker.setLngLat([pos.coords.longitude, pos.coords.latitude]);
            }, null, { enableHighAccuracy: true });
        }

        // 6. Routing
        async function calculateCampusRoute() {
            // Clear previous dest marker
            if (activeDestMarker) activeDestMarker.remove();

            const destValue = document.getElementById('dest-nodes').value;
            const [destLng, destLat] = destValue.split(',').map(Number);
            const startCoords = userMarker.getLngLat().toArray().join(',');

            // Feature: Destination IS still draggable just in case
            activeDestMarker = new mapboxgl.Marker({ draggable: true, color: '#e74c3c' })
                .setLngLat([destLng, destLat])
                .addTo(map);

            activeDestMarker.on('dragend', async () => {
                const newLngLat = activeDestMarker.getLngLat();
                await fetchRoute(startCoords, `${newLngLat.lng},${newLngLat.lat}`);
            });

            await fetchRoute(startCoords, `${destLng},${destLat}`);

            const bounds = new mapboxgl.LngLatBounds();
            bounds.extend(userMarker.getLngLat());
            bounds.extend([destLng, destLat]);
            map.fitBounds(bounds, { padding: 80, pitch: 60 });
        }

        async function fetchRoute(start, end) {
            const loading = document.getElementById('loading');
            loading.style.display = 'block';
            try {
                const url = `https://api.mapbox.com/directions/v5/mapbox/walking/${start};${end}?geometries=geojson&steps=true&access_token=${mapboxgl.accessToken}`;
                const req = await fetch(url);
                const json = await req.json();

                if (!json.routes || json.routes.length === 0) {
                    alert("No path found. Try satellite view.");
                    return;
                }

                const route = json.routes[0];
                document.getElementById('dist-txt').innerText = Math.round(route.distance) + " m";
                document.getElementById('eta-txt').innerText = Math.round(route.duration / 60) + " min";

                drawRoute(route.geometry);

                // Draw Off-Road Connection Line (Green Dashed)
                drawConnectionLine(userMarker.getLngLat().toArray(), route.geometry.coordinates[0]);

            } catch (e) { console.error(e); }
            finally { loading.style.display = 'none'; }
        }

        function drawRoute(geojson) {
            if (map.getSource('route')) {
                map.getSource('route').setData(geojson);
            } else {
                map.addLayer({
                    id: 'route', type: 'line',
                    source: { type: 'geojson', data: { type: 'Feature', geometry: geojson } },
                    layout: { 'line-join': 'round', 'line-cap': 'round' },
                    paint: { 'line-color': '#ff9f43', 'line-width': 6, 'line-opacity': 0.9 }
                });
                map.addLayer({
                    id: 'route-casing', type: 'line',
                    source: 'route', beforeId: 'route',
                    layout: { 'line-join': 'round', 'line-cap': 'round' },
                    paint: { 'line-color': '#000', 'line-width': 9 }
                });
            }
        }

        function drawConnectionLine(from, to) {
            const geojson = { type: 'Feature', geometry: { type: 'LineString', coordinates: [from, to] } };
            if (map.getSource('connector-line')) {
                map.getSource('connector-line').setData(geojson);
            } else {
                map.addSource('connector-line', { type: 'geojson', data: geojson });
                map.addLayer({
                    id: 'connector-line-dashed', type: 'line', source: 'connector-line',
                    paint: { 'line-color': '#2ecc71', 'line-width': 4, 'line-dasharray': [2, 2] }
                });
            }
        }

        function toggleMapStyle() {
            currentStyle = currentStyle.includes('satellite') ? 'mapbox://styles/mapbox/standard' : 'mapbox://styles/mapbox/satellite-v9';
            map.setStyle(currentStyle);
            map.once('style.load', () => {
                // Re-hide default points
                if (map.getLayer('poi-label')) map.setLayoutProperty('poi-label', 'visibility', 'none');
                addCustomCampusLayer();
            });
        }
    </script>
</body>

</html>